from aiogram import Router, F, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
import logging
from config import SUPER_ADMIN_ID

from loader import get_db
from bot_utils import get_main_keyboard  # –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º IsAdmin –∑–¥–µ—Å—å, –æ–Ω –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è /help

# from filters.admin import IsAdmin # –£–±–∏—Ä–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞

router = Router()
logger = logging.getLogger(__name__)


@router.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    db = get_db()
    user = message.from_user
    try:
        db.upsert_user(
            user_id=user.id,
            username=user.username,
            first_name=user.first_name,
            last_name=user.last_name
        )
        logger.info(f"User {user.id} ({user.username or 'NoUsername'}) started/updated.")
    except Exception as e:
        logger.error(f"Failed to upsert user {user.id} on /start: {e}", exc_info=True)

    current_fsm_state = await state.get_state()
    if current_fsm_state is not None:
        await state.clear()
        await message.answer("–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–±—Ä–æ—à–µ–Ω–æ. –ù–∞—á–∏–Ω–∞–µ–º —Å–Ω–∞—á–∞–ª–∞.",
                             reply_markup=get_main_keyboard())

    await message.answer(
        "ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TelePost Manager!\n"
        "–Ø –ø–æ–º–æ–≥—É –≤–∞–º —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏ –≤ –≤–∞—à–∏—Ö Telegram-–∫–∞–Ω–∞–ª–∞—Ö.",
        reply_markup=get_main_keyboard()
    )


@router.message(F.text == "üÜò –ü–æ–º–æ—â—å")
@router.message(Command("help"))
async def cmd_help(message: types.Message):
    user_id = message.from_user.id
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–º, –Ω–∞–ø—Ä—è–º—É—é —Å—Ä–∞–≤–Ω–∏–≤–∞—è ID
    is_super_admin_user = (user_id == SUPER_ADMIN_ID)

    help_text_parts = [
        "<b>TelePost Manager Bot</b> - –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏ –≤ Telegram-–∫–∞–Ω–∞–ª–∞—Ö.\n",
        "üìã <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n",
        "‚ñ´Ô∏è /start - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞, –ø–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        "‚ñ´Ô∏è /help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n",
        "‚ñ´Ô∏è /cancel - –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –∏–ª–∏ —à–∞–±–ª–æ–Ω–∞).\n",

        "<b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º:</b>",
        "‚ñ´Ô∏è <b>üìù –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</b> (–∏–ª–∏ /new_post) - –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞.",
        "‚ñ´Ô∏è <b>üóìÔ∏è –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</b> (–∏–ª–∏ /my_scheduled) - –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ –æ—Ç–º–µ–Ω–∏—Ç—å –≤–∞—à–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã.\n",

        "<b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏:</b>",
        "‚ñ´Ô∏è <b>üì¢ –ú–æ–∏ –∫–∞–Ω–∞–ª—ã</b> (–∏–ª–∏ /my_channels) - –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏ —É–¥–∞–ª–∏—Ç—å –∏—Ö.",
        "‚ñ´Ô∏è <b>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</b> (–∏–ª–∏ /add_channel) - –ü–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.\n",

        "<b>–®–∞–±–ª–æ–Ω—ã:</b>",
        "‚ñ´Ô∏è <b>üìö –®–∞–±–ª–æ–Ω—ã</b> (–∏–ª–∏ /templates) - –£–ø—Ä–∞–≤–ª—è—Ç—å —à–∞–±–ª–æ–Ω–∞–º–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤ (–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—â–∏—Ö, —Å–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã—Ö).",
        "   - –í–Ω—É—Ç—Ä–∏ –º–µ–Ω—é —à–∞–±–ª–æ–Ω–æ–≤ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.\n",

        "<b>–ò—Å—Ç–æ—Ä–∏—è:</b>",
        "‚ñ´Ô∏è <b>üìú –ò—Å—Ç–æ—Ä–∏—è</b> (–∏–ª–∏ /history) - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤–∞—à–∏—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π.\n",

        "‚öôÔ∏è <b>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª:</b>",
        "1. –ù–∞–∂–º–∏—Ç–µ ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª¬ª –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /add_channel.",
        "2. –°–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å –ø—Ä–∞–≤–æ–º –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π.",
        "3. –ü–µ—Ä–µ—à–ª–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.\n",

        "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:",
        "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≤ –Ω—É–∂–Ω–æ–º –∫–∞–Ω–∞–ª–µ –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é.",
        "2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start.",
        "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /cancel –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –µ—Å–ª–∏ –±–æ—Ç '–∑–∞–≤–∏—Å'."
    ]

    if is_super_admin_user:
        help_text_parts.extend([
            "\nüëë <b>–ö–æ–º–∞–Ω–¥—ã –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</b>\n",
            "‚ñ´Ô∏è /add_banned_word <i>—Å–ª–æ–≤–æ</i> - –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫.",
            "‚ñ´Ô∏è /remove_banned_word <i>—Å–ª–æ–≤–æ</i> - –£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.",
            "‚ñ´Ô∏è /list_banned_words - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤.\n",
            "‚ñ´Ô∏è /admin_stats - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞.",
            "‚ñ´Ô∏è /list_users <i>N</i> - –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)."
        ])

    await message.answer("\n".join(help_text_parts), reply_markup=get_main_keyboard(), parse_mode="HTML")


@router.message(Command("cancel"))
@router.message(F.text.lower() == "–æ—Ç–º–µ–Ω–∞")
async def cmd_cancel(message: types.Message, state: FSMContext):
    current_fsm_state = await state.get_state()
    if current_fsm_state is None:
        await message.answer("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã.", reply_markup=get_main_keyboard())
        return

    logger.info(f"User {message.from_user.id} cancelled state {current_fsm_state}")
    await state.clear()
    await message.answer("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=get_main_keyboard())